<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Migração de Dados - Agendamento App</title>
</head>
<body style="font-family: Arial, sans-serif; padding: 2rem;">
  <h1>Migração de Dados</h1>
  <p>Faça login e clique em <b>Migrar Dados</b> para corrigir documentos antigos sem <code>userId</code>.</p>

  <button id="migrar">Migrar Dados</button>
  <pre id="log" style="background:#f4f4f4; padding:1rem; margin-top:1rem; max-height:400px; overflow:auto;"></pre>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // Configuração do Firebase (use a mesma do app.js)
    const firebaseConfig = {
      apiKey: "AIzaSyAza98u8-NVn9hNbuLwcsaCZX2hXbtVaHk",
      authDomain: "meu-app-de-login.firebaseapp.com",
      projectId: "meu-app-de-login",
      storageBucket: "meu-app-de-login.appspot.com",
      messagingSenderId: "61119567504",
      appId: "1:61119567504:web:556bb893c9eba6c4e12a15",
      measurementId: "G-YY6QTZX57K"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const log = (msg) => {
      document.getElementById("log").textContent += msg + "\\n";
    };

    document.getElementById("migrar").addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) {
        alert("Você precisa estar logado!");
        return;
      }
      const uid = user.uid;
      log("Iniciando migração para o usuário: " + uid);

      const colecoes = ["clientes", "representantes", "produtos", "agendamentos"];

      for (let col of colecoes) {
        log("Verificando coleção: " + col);
        const snap = await db.collection(col).get();
        let count = 0;
        for (let doc of snap.docs) {
          const data = doc.data();
          if (!data.userId) {
            await db.collection(col).doc(doc.id).update({ userId: uid });
            count++;
          }
        }
        log(`Coleção ${col}: ${count} documentos atualizados.`);
      }

      log("Migração concluída!");
    });

    // Faz login anônimo só para permitir migração rápida (opcional)
    auth.signInAnonymously().catch((err) => {
      log("Erro no login anônimo: " + err.message);
    });
  </script>
</body>
</html>
